import{_ as se,i as N,o as G,c as W,b as r,w,P as H,n as le,aa as c,p as ie,d as re,a as e,a8 as U,e as v,x as B,y as X,a4 as ke,f as Le,h as Me,al as xe,Z as Se,g as $,A as Ce,u as C,C as Y,D as j,F as Ne,j as z,t as ee,am as te,J as ae,an as oe,ao as ne,v as O,ap as Re,aq as Te}from"./index-6YJPzaKF.js";/* empty css                       */import{M as De}from"./ModelTitle-BWwbr8w2.js";import{u as ce,F as Ie,E as Oe}from"./eulerFlowLayer-C0JT3SmO.js";import{M as Ee}from"./modelRunner-BRKkW5m6.js";import{a as Fe}from"./realtimeWaterCondition-BmZvMAbM.js";import"./FlowFieldController-CClZrjyg.js";const Ve=M=>(ie("data-v-5c87a886"),M=M(),re(),M),Pe=Ve(()=>e("div",{class:"arrow-down"},null,-1)),Ue={__name:"popover",setup(M){const a=ce(),E=()=>{const g=a.focusingMarkerDom;a.removeMarkerInfo(g),c({type:"info",title:"提示",message:"删除潮位点",offset:120})},F=()=>{const g=a.focusingMarkerDom,l=a.getMarkerInfo(g);l.option?(c({type:"info",title:"查看潮位数据",message:`经度：${l.lng.toFixed(4)}，纬度：${l.lat.toFixed(4)}`,offset:120}),a.showingOption=l.option):c({type:"warning",title:"提示",message:"此点潮位数据尚未计算",offset:120})};return(g,l)=>{const T=N("el-button");return G(),W("div",{class:"my-popover flex-row",style:le(g.dynamicPos)},[r(T,{type:"primary",pla:"",style:{padding:"0px 8px"},onClick:F},{default:w(()=>[H("查看")]),_:1}),r(T,{type:"warning",style:{padding:"0px 8px"},onClick:E},{default:w(()=>[H("删除")]),_:1}),Pe],4)}}},Be=se(Ue,[["__scopeId","data-v-5c87a886"]]),h=M=>(ie("data-v-efc11ff0"),M=M(),re(),M),$e={class:"stability-analysis"},ze={class:"main-content"},He={class:"model-choice"},Ae={class:"basemap-radio-container"},Je={class:"model-pannel"},Ye={class:"real-content"},je={class:"condition-configure flex-row"},Ge=h(()=>e("div",{class:"title"},[e("div",{class:"title-div"},"水文条件配置"),e("div",{class:"arrow-up"})],-1)),We={class:"content"},Ke={class:"condition-card"},qe=h(()=>e("div",{class:"set-icon"},null,-1)),Ze=h(()=>e("div",{class:"center"}," 实时评估 ",-1)),Qe={class:"realtime-water-condition"},Xe={class:"water-condition-item"},et=h(()=>e("span",{class:"water-condition-title"},"流量：",-1)),tt={class:"water-condition-item"},at=h(()=>e("span",{class:"water-condition-title"},"潮差：",-1)),ot={class:"model-running flex-row"},nt=h(()=>e("div",{class:"title"},[e("div",{class:"title-div"},"模型计算"),e("div",{class:"arrow-up"})],-1)),st={class:"content"},lt={class:"content-box"},it={class:"running-status grid-content"},rt={class:"grid-content"},ct={class:"progress-container"},dt={class:"visulization-result flex-row"},ut=h(()=>e("div",{class:"title"},[e("div",{class:"title-div"},"结果可视化 ")],-1)),ft={class:"content"},mt={class:"slide-control-block"},gt=["checked","disabled"],pt=h(()=>e("span",{class:"slider"},null,-1)),vt=h(()=>e("div",{class:"text-block"},[e("div",{class:"text"},"拉格朗日场")],-1)),_t={class:"slide-control-block"},yt=["checked","disabled"],wt=h(()=>e("span",{class:"slider"},null,-1)),ht=h(()=>e("div",{class:"text-block"},[e("div",{class:"text"},"欧拉场")],-1)),bt={class:"model-pannel2"},kt={class:"model-content flex-center"},Lt={class:"flex-coloum",style:{width:"18.7vw",height:"23vh"}},Mt={class:"title"},xt={class:"content flex-center"},St={key:0,style:{"z-index":"10"}},Ct={class:"loading-container"},Nt={class:"loading-message"},Rt={__name:"StabilityAnalysis3",setup(M){let a=U({taskID:null,caseID:null,pngPrefix:null,visualizationJsonUrl:null,stationBinUrl:null,uvBinUrls:null,status:!1,runningStatus:"NONE",lagrangeLayer:"flowLayer1",eulerLayer:"flowLayer2"});const E=v(null),F=v(null),g=B(),l=ce(),T=v(X().format("YYYY-MM-DD HH:mm:ss")),_=v(0),x=v("未运行"),b=v(0),y=v(""),S=v(!1),K=v("0"),D=v({flow:null,maxTide:null,minTide:null,tideType:null}),de=ke(),A=v(1);let V=null;const ue=t=>{console.log(t=="1");const o={1:"/modelStore/stabilityAnalysis",2:"/modelStore/stabilityCalc",3:"/modelStore/analysisCenter"};o[t]&&de.push(o[t])},R=v({flow:null,diffTide:null}),fe=Le(()=>{switch(x.value){case"未运行":return{color:"rgb(201, 0, 0)"};case"运行中":return{color:"rgb(255, 165, 0)"};case"运行完毕":return{color:"rgb(0, 180, 0)"};case"运行失败":return{color:"rgb(255, 0, 0)"};default:return{color:"rgb(255, 255, 255)"}}}),I=U({name:null,bankEnName:null}),me=async t=>{I.name=t.name,I.bankEnName=t.bankEnName,he(g.getMap(map),t.name),c({type:"success",title:"选择岸段",message:`已选择岸段——${I.name},模型计算将采用该岸段相关资源`,position:"top-right",offset:200})},q=t=>{if(K.value==="0"){if(t.flow===null||t.flow<5e3||t.flow>5e5||t.tideType===null)return!1}else if(K.value==="1"&&(t.flow===null||t.flow<5e3||t.flow>5e5||t.maxTide===null||t.maxTide<0||t.maxTide>100||t.minTide===null||t.minTide<0||t.minTide>100))return!1;return!0},ge=t=>{console.log("conditionClickHandler",t),_.value=0,p("lagrange",!1),p("euler",!1),D.value={flow:Number(R.value.flow),diffTide:Number(R.value.diffTide)},q(D.value)?c({title:"水文条件配置成功",offset:200,type:"success"}):c({title:"水文条件配置失败",message:"请检查输入是否合法",offset:200,type:"error"}),b.value=0,x.value="未运行",a.status=!1},pe=async()=>{if(I.name===null){c({title:"提示",message:"请先选择岸段，获取岸段绑定的相关资源",offset:200,type:"info"});return}if(!q(D.value)){c({title:"运行失败",message:"请检查输入是否合法",offset:200,type:"error"});return}if(y.value==="模型正在运行，请稍后..."){c({type:"info",title:"模型正在运行",message:"请勿重复提交",offset:200});return}({NONE:()=>{y.value="模型正在运行，请稍后...",S.value=!0,Z()},RUNNING:()=>{ne.confirm("模型正在运行，请勿重复提交","警告",{showConfirmButton:!1,showCancelButton:!0,cancelButtonText:"取消",type:"warning"}),a.status=!1},COMPLETE:()=>{ne.confirm("已有运行结果，是否采用新工况重新运行？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{console.log("run with new condition"),_.value=0,p("lagrange",!1),p("euler",!1),V.clear(),a.status=!1,y.value="模型正在运行，请稍后...",S.value=!0,Z()}).catch(()=>{console.log("do nothing")})},ERROR:()=>{}})[a.runningStatus]()},Z=async t=>{x.value="运行中",b.value=0;let o="",n={};o="/model/taskNode/start/numeric/hydrodynamic",n={"water-qs":D.value.flow,"tidal-level":D.value.diffTide,segment:I.bankEnName,set:"standard",year:"2023"};try{const d=(await O.post(o,n)).data;if(console.log("TASK_ID ",d),d==="WRONG")throw new Error;x.value="运行中",b.value=0,a.taskID=d;let i=setInterval(async()=>{let s=(await O.get("/model/taskNode/status/id?taskId="+d)).data;console.log("runningResult ",s),x.value="运行中";let m=3;if(s==="LOCK"||s==="UNLOCK"||s==="RUNNING"){a.runningStatus="RUNNING",b.value<88&&(m=1),b.value>88&&(m=.5),b.value>95&&(m=.1);let u=Math.round((b.value+Math.random()*m)*100)/100;u=u>95?95:u,b.value=u}else if(s==="ERROR"){a.runningStatus="ERROR",y.value="",S.value=!1;const u=`/model/taskNode/result/id?taskId=${d}`;O.get(u).then(f=>{let J=f.data["error-log"];resolve(J)}).catch(f=>{console.warn(f),reject(f)});const L=(await O.get(u)).data["error-log"];c({title:"模型运行失败",message:`错误原因:
`+L,offset:200,type:"error"}),x.value="运行失败",a.runningStatus="NONE",clearInterval(i)}else if(s==="COMPLETE"){y.value="",S.value=!1,clearInterval(i);let u=(await O.get("/model/taskNode/result/id?taskId="+d)).data;console.log("runningResult ",u),a.caseID=u["case-id"],a.pngPrefix="/model/data/bankResource/down/modelServer/resource/file/image?name=",a.binPrefix="/model/data/bankResource/down/modelServer/resource/file/bin?name=",a.stationBinUrl=u["visualization-station-bin"],a.uvBinUrls=u["visualization-uv-bin"];let L=`/model/data/bankResource/down/modelServer/resource/file/json?name=${u["visualization-description-json"]}`;a.visualizationJsonUrl=L,console.log("globle data info::",a),a.status=!0,a.runningStatus="COMPLETE",x.value="运行完毕",b.value=100}},500)}catch{c({title:"模型运行失败",offset:200,type:"error"}),x.value="运行失败",y.value="运行失败",a.runningStatus="NONE",S.value=!1}};let k=null;const p=(t,o)=>{let n=g.getMap();({lagrange:{add:()=>{console.log("add lagrenge"),k&&k();let i=U(new Ie(a.lagrangeLayer,a.visualizationJsonUrl,a.pngPrefix));k=$(()=>i.stepProgressRate,s=>{l.flowFieldCurrentTimeStep=s}),g.getMap().addLayer(i,"mzsLabel")},remove:()=>{console.log("rm lagrenge"),k&&k(),l.flowFieldCurrentTimeStep=0,n.getLayer(a.lagrangeLayer)&&n.removeLayer(a.lagrangeLayer)}},euler:{add:()=>{console.log("add euler"),k&&k();let i=U(new Oe(a.eulerLayer,a.stationBinUrl,a.uvBinUrls,a.binPrefix));k=$(()=>i.stepProgressRate,s=>{l.flowFieldCurrentTimeStep=s}),g.getMap().addLayer(i,"mzsLabel")},remove:()=>{console.log("rm euler"),k&&k(),l.flowFieldCurrentTimeStep=0,n.getLayer(a.eulerLayer)&&n.removeLayer(a.eulerLayer)}}})[t][o?"add":"remove"]()},Q=t=>{if(!a.status){c({title:"错误",message:"模型尚未运行或运行未结束，缺乏可视化依赖数据",offset:200,type:"error"}),_.value=0;return}if(t===1){if(_.value=_.value===1?0:1,p("euler",!1),!_.value){p("lagrange",!1);return}p("lagrange",!0);return}else if(t===2){if(_.value=_.value===2?0:2,p("lagrange",!1),!_.value){p("euler",!1);return}p("euler",!0);return}},ve=()=>{const t=document.createElement("div");return Re(Be).use(Te).mount(t),t};let P=!1;const _e=()=>{if(!a.status){c({title:"警告",message:"水动力模型计算完成后方可提取潮位过程线",type:"warning",offset:200});return}if(y.value==="正在提取潮位线..."){c({title:"警告",message:"请等待当前任务完成，请稍后...",type:"warning",offset:200});return}c({title:"提示",message:"进入绘制状态，点击地图以添加潮位点",type:"info",offset:200});let t=g.getMap(),o=t.getCanvasContainer();if(o.style.cursor="crosshair",P===!1)t.once("click",n=>{const d=ve(),i=new ae.Popup().setDOMContent(d),s=new ae.Marker({color:"#ff6804ff"}).setLngLat(n.lngLat).setPopup(i).addTo(t),m=s.getElement();l.addMarkerInfo(s,m,n.lngLat.lng,n.lngLat.lat),m.addEventListener("click",function(u){const L=this;l.focusingMarkerDom=L}),c({type:"info",title:"新添潮位点",message:`经度：${n.lngLat.lng.toFixed(4)}，纬度：${n.lngLat.lat.toFixed(4)}`,offset:200}),l.calculatingMarkerDom=m,ye(n.lngLat.lng,n.lngLat.lat),o.style.cursor="grab"}),P=!0;else return},ye=async(t,o)=>{const n="/model/taskNode/start/numeric/getFlowFieldVelocities",d={"case-id":a.caseID,"sample-points":[{lng:t,lat:o}]};S.value=!0,y.value="正在提取潮位线...";const i=new Ee(n,d);await i.modelStart(),console.log("===Interval");let s=setInterval(async()=>{switch(await i.getRunningStatus()){case"RUNNING":break;case"ERROR":console.log("error"),clearInterval(s);let u=await i.getErrorLog();c({title:"计算失败",message:`错误原因:
`+u,offset:200,type:"error"}),S.value=!1,y.value="",P=!1;break;case"COMPLETE":console.log("complete"),clearInterval(s),c({title:"计算成功",offset:200,type:"success"});let L=await i.getModelResult(),f=we(L);l.showingOption=f;let J={option:f};l.appendMarkerInfo(l.calculatingMarkerDom,J),l.calculatingMarkerDom=null,console.log("runningResult ",L),S.value=!1,y.value="",P=!1;break}},1e3)},we=t=>{const o=t.result[0].us,n=t.result[0].vs;return{grid:{left:"1%",right:"3%",bottom:"12%",top:"17%",containLabel:!0},tooltip:{trigger:"axis"},xAxis:{type:"category",data:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],name:"时间步",nameLocation:"middle",nameGap:23,nameTextStyle:{fontWeight:"bold"}},yAxis:{type:"value",name:"速度(m/s)",nameTextStyle:{fontWeight:"bold"}},series:[{name:"东西向流速",data:o,type:"line",symbol:"none"},{name:"南北向流速",data:n,type:"line",symbol:"none"}]}},he=(t,o)=>{if(!t)return;let n={民主沙:[[120.45997922676835,32.00001616423072],[120.60909640208264,32.084171362618626]],民主沙右缘:[[120.45997922676835,32.00001616423072],[120.60909640208264,32.084171362618626]]};n[o]&&t.fitBounds(n[o],{duration:1500})},be=async()=>{const t=await Fe();T.value=X().format("YYYY-MM-DD HH:mm:ss"),R.value={flow:t.flow,diffTide:t.level},c({message:`获取实时水文条件，更新时间：${T.value}`,offset:200,position:"top-right",type:"success"})};return Me(async()=>{let t=await xe(E.value);g.setMap(t),V=Se(F.value);let o=null;$(()=>l.showingOption,n=>{o&&o();let d=JSON.parse(JSON.stringify(oe(n)));console.log("showing option change!::",d),V.setOption(d),o=$(()=>l.flowFieldCurrentTimeStep,i=>{console.log("newVal::",i);let s=JSON.parse(JSON.stringify(oe(l.showingOption))),m=l.getMarkLineOption();s.series[0].markLine=m,V.setOption(s)})})}),Ce(()=>{B().getMap()&&(p("lagrange",!1),p("euler",!1),B().getMap().remove(),B().destroyMap())}),(t,o)=>{const n=N("el-radio-button"),d=N("el-radio-group"),i=N("el-input"),s=N("el-col"),m=N("el-row"),u=N("el-progress"),L=N("dv-loading");return G(),W(Ne,null,[e("div",$e,[r(De,{ModelName:"近岸动力分析模型",onConfirmBank:me}),e("div",ze,[e("div",{class:"map",id:"map",ref_key:"mapRef",ref:E},null,512),e("div",He,[e("div",Ae,[r(d,{modelValue:A.value,"onUpdate:modelValue":o[0]||(o[0]=f=>A.value=f),onChange:o[1]||(o[1]=f=>ue(A.value))},{default:w(()=>[r(n,{label:"近岸动力评估",value:"1"}),r(n,{label:"近岸动力计算",value:"2"}),r(n,{label:"近岸演变分析",value:"3"})]),_:1},8,["modelValue"])])]),e("div",Je,[r(C(te),{dur:5,color:["rgb(28, 75, 187)","rgb(140, 255, 255)"]},{default:w(()=>[e("div",Ye,[e("div",je,[Ge,e("div",We,[e("div",Ke,[qe,Ze,e("div",Qe,[e("div",Xe,[et,r(i,{modelValue:R.value.flow,"onUpdate:modelValue":o[2]||(o[2]=f=>R.value.flow=f),style:{width:"7vw",height:"3vh"},placeholder:"请输入流量"},null,8,["modelValue"])]),e("div",tt,[at,r(i,{modelValue:R.value.diffTide,"onUpdate:modelValue":o[3]||(o[3]=f=>R.value.diffTide=f),style:{width:"7vw",height:"3vh"},placeholder:"请输入潮差"},null,8,["modelValue"])])]),e("button",{class:"realtime-button",onClick:o[4]||(o[4]=f=>be())}," 实时水文条件 "),e("button",{class:z(["condition-button",{active:!0}]),onClick:o[5]||(o[5]=f=>ge("custom"))}," 确定 ")])])]),e("div",ot,[nt,e("div",st,[e("div",lt,[r(m,null,{default:w(()=>[r(s,{span:10},{default:w(()=>[e("div",it,[H(" 状态："),e("span",{style:le(fe.value)},ee(x.value),5)])]),_:1}),r(s,{span:6}),r(s,{span:8},{default:w(()=>[e("div",{class:"running-control grid-content"},[e("div",{class:"run-button",onClick:pe},"运行 ")])]),_:1})]),_:1}),r(m,null,{default:w(()=>[r(s,{span:24},{default:w(()=>[e("div",rt,[e("div",ct,[r(u,{percentage:b.value,"stroke-width":15,striped:""},null,8,["percentage"])])])]),_:1})]),_:1})])])]),e("div",dt,[ut,e("div",ft,[e("div",mt,[e("label",{class:z(["switch",{forbbidden:C(a).status===!1}])},[e("input",{type:"checkbox",checked:_.value==1,disabled:C(a).status===!1,onClick:o[6]||(o[6]=f=>Q(1))},null,8,gt),pt],2),vt]),e("div",_t,[e("label",{class:z(["switch",{forbbidden:C(a).status===!1}])},[e("input",{type:"checkbox",checked:_.value==2,disabled:C(a).status===!1,onClick:o[7]||(o[7]=f=>Q(2))},null,8,yt),wt],2),ht])])])])]),_:1})]),e("div",bt,[r(C(te),{dur:5,color:["rgb(28, 75, 187)","rgb(140, 255, 255)"]},{default:w(()=>[e("div",kt,[e("div",Lt,[e("div",Mt,[H("● 潮位过程线提取 "),e("div",{class:z(["button",{forbbidden:C(a).status===!1}]),onClick:_e},"测点绘制",2)]),Y(e("div",{class:"content flex-center",ref_key:"tideLineChartDom",ref:F},null,512),[[j,C(a).status]]),Y(e("div",xt,[(G(),W("span",St,"请在计算模型后绘制潮位点以提取潮位线"))],512),[[j,C(a).status===!1]])])])]),_:1})])])]),Y(e("div",Ct,[r(L,{class:"loading-icon"},{default:w(()=>[e("div",Nt,ee(y.value),1)]),_:1})],512),[[j,S.value]])],64)}}},Ut=se(Rt,[["__scopeId","data-v-efc11ff0"]]);export{Ut as default};
