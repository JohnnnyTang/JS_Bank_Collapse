import{_ as ne,i as N,o as G,c as W,b as c,d as w,D as H,n as le,a7 as d,p as ie,e as re,a as e,a5 as U,f as p,x as P,ai as Z,a2 as ke,g as Le,h as Me,aj as xe,Y as Se,w as $,z as Ce,u as C,B as J,C as j,F as Ne,j as z,t as ee,ak as te,J as ae,al as oe,am as se,v as O,an as Re,ao as Te}from"./index-DnetMu32.js";/* empty css                       */import{M as De}from"./ModelTitle-B0YLcx-e.js";import{u as ce,F as Ie,E as Oe}from"./eulerFlowLayer-C_0wVGHG.js";import{M as Ee}from"./modelRunner-3hLM3M0w.js";import{a as Fe}from"./realtimeWaterCondition-Jzv8_0OY.js";import"./bankResourceHelper-l77fC2gR.js";import"./FlowFieldController-CClZrjyg.js";const Ve=x=>(ie("data-v-5c87a886"),x=x(),re(),x),Be=Ve(()=>e("div",{class:"arrow-down"},null,-1)),Ue={__name:"popover",setup(x){const a=ce(),E=()=>{const g=a.focusingMarkerDom;a.removeMarkerInfo(g),d({type:"info",title:"提示",message:"删除潮位点",offset:120})},F=()=>{const g=a.focusingMarkerDom,l=a.getMarkerInfo(g);l.option?(d({type:"info",title:"查看潮位数据",message:`经度：${l.lng.toFixed(4)}，纬度：${l.lat.toFixed(4)}`,offset:120}),a.showingOption=l.option):d({type:"warning",title:"提示",message:"此点潮位数据尚未计算",offset:120})};return(g,l)=>{const T=N("el-button");return G(),W("div",{class:"my-popover flex-row",style:le(g.dynamicPos)},[c(T,{type:"primary",pla:"",style:{padding:"0px 8px"},onClick:F},{default:w(()=>[H("查看")]),_:1}),c(T,{type:"warning",style:{padding:"0px 8px"},onClick:E},{default:w(()=>[H("删除")]),_:1}),Be],4)}}},Pe=ne(Ue,[["__scopeId","data-v-5c87a886"]]),y=x=>(ie("data-v-dffbe501"),x=x(),re(),x),$e={class:"stability-analysis"},ze={class:"main-content"},He={class:"model-choice"},Ae={class:"basemap-radio-container"},Ye={class:"model-pannel"},Je={class:"real-content"},je={class:"condition-configure flex-row"},Ge=y(()=>e("div",{class:"title"},[e("div",{class:"title-div"},"水文条件配置"),e("div",{class:"arrow-up"})],-1)),We={class:"content"},Ke={class:"condition-card"},qe=y(()=>e("div",{class:"set-icon"},null,-1)),Qe=y(()=>e("div",{class:"center"}," 实时评估 ",-1)),Xe={class:"realtime-water-condition"},Ze={class:"water-condition-item"},et=y(()=>e("span",{class:"water-condition-title"},"流量：",-1)),tt={class:"water-condition-item"},at=y(()=>e("span",{class:"water-condition-title"},"潮差：",-1)),ot={class:"model-running flex-row"},st=y(()=>e("div",{class:"title"},[e("div",{class:"title-div"},"模型计算"),e("div",{class:"arrow-up"})],-1)),nt={class:"content"},lt={class:"content-box"},it={class:"running-status grid-content"},rt={class:"grid-content"},ct={class:"progress-container"},dt={class:"visulization-result flex-row"},ut=y(()=>e("div",{class:"title"},[e("div",{class:"title-div"},"结果可视化 ")],-1)),ft={class:"content"},mt={class:"slide-control-block"},gt=["checked","disabled"],vt=y(()=>e("span",{class:"slider"},null,-1)),pt=y(()=>e("div",{class:"text-block"},[e("div",{class:"text"},"拉格朗日场")],-1)),_t={class:"slide-control-block"},wt=["checked","disabled"],yt=y(()=>e("span",{class:"slider"},null,-1)),ht=y(()=>e("div",{class:"text-block"},[e("div",{class:"text"},"欧拉场")],-1)),bt={class:"model-pannel2"},kt={class:"model-content flex-center"},Lt={class:"flex-coloum",style:{width:"18.7vw",height:"23vh"}},Mt={class:"title"},xt={class:"content flex-center"},St={key:0,style:{"z-index":"10"}},Ct={class:"loading-container"},Nt={class:"loading-message"},Rt={__name:"StabilityAnalysis3",setup(x){let a=U({taskID:null,caseID:null,pngPrefix:null,visualizationJsonUrl:null,stationBinUrl:null,uvBinUrls:null,status:!1,runningStatus:"NONE",lagrangeLayer:"flowLayer1",eulerLayer:"flowLayer2"});const E=p(null),F=p(null),g=P(),l=ce(),T=p(Z().format("YYYY-MM-DD HH:mm:ss")),_=p(0),h=p("未运行"),b=p(0),k=p(""),S=p(!1),K=p("0"),D=p({flow:null,maxTide:null,minTide:null,tideType:null}),de=ke(),A=p(1);let V=null;const ue=t=>{console.log(t=="1");const o={1:"/modelStore/stabilityAnalysis",2:"/modelStore/stabilityCalc",3:"/modelStore/analysisCenter"};o[t]&&de.push(o[t])},R=p({flow:null,diffTide:null}),fe=Le(()=>{switch(h.value){case"未运行":return{color:"rgb(255, 2, 2)"};case"运行中":return{color:"rgb(255, 165, 0)"};case"运行完毕":return{color:"rgb(0, 180, 0)"};default:return{color:"rgb(255, 255, 255)"}}}),I=U({name:null,bankEnName:null}),me=async t=>{I.name=t.name,I.bankEnName=t.bankEnName,he(g.getMap(map),t.name),d({type:"success",title:"选择岸段",message:`已选择岸段——${I.name},模型计算将采用该岸段相关资源`,position:"top-right",offset:250})},q=t=>{if(K.value==="0"){if(t.flow===null||t.flow<5e3||t.flow>5e5||t.tideType===null)return!1}else if(K.value==="1"&&(t.flow===null||t.flow<5e3||t.flow>5e5||t.maxTide===null||t.maxTide<0||t.maxTide>100||t.minTide===null||t.minTide<0||t.minTide>100))return!1;return!0},ge=t=>{console.log("conditionClickHandler",t),_.value=0,v("lagrange",!1),v("euler",!1),D.value={flow:Number(R.value.flow),diffTide:Number(R.value.diffTide)},q(D.value)?d({title:"水文条件配置成功",offset:250,type:"success"}):d({title:"水文条件配置失败",message:"请检查输入是否合法",offset:250,type:"error"}),b.value=0,h.value="未运行",a.status=!1},ve=async()=>{if(I.name===null){d({title:"提示",message:"请先选择岸段，获取岸段绑定的相关资源",offset:250,type:"info"});return}if(!q(D.value)){d({title:"运行失败",message:"请检查输入是否合法",offset:250,type:"error"});return}if(k.value==="模型正在运行，请稍后..."){d({type:"info",title:"模型正在运行",message:"请勿重复提交",offset:250});return}({NONE:()=>{k.value="模型正在运行，请稍后...",S.value=!0,Q()},RUNNING:()=>{se.confirm("模型正在运行，请勿重复提交","警告",{showConfirmButton:!1,showCancelButton:!0,cancelButtonText:"取消",type:"warning"}),a.status=!1},COMPLETE:()=>{se.confirm("已有运行结果，是否采用新工况重新运行？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{console.log("run with new condition"),_.value=0,v("lagrange",!1),v("euler",!1),V.clear(),a.status=!1,k.value="模型正在运行，请稍后...",S.value=!0,Q()}).catch(()=>{console.log("do nothing")})},ERROR:()=>{}})[a.runningStatus]()},Q=async t=>{h.value="运行中",b.value=0;let o="",s={};o="/model/taskNode/start/numeric/hydrodynamic",s={"water-qs":D.value.flow,"tidal-level":D.value.diffTide,segment:I.bankEnName,set:"standard",year:"2023"};try{const r=(await O.post(o,s)).data;if(console.log("TASK_ID ",r),r==="WRONG")throw new Error("缺乏相关资源文件");h.value="运行中",b.value=0,a.taskID=r;let i=setInterval(async()=>{let n=(await O.get("/model/taskNode/status/id?taskId="+r)).data;console.log("runningResult ",n),h.value="运行中";let m=3;if(n==="LOCK"||n==="UNLOCK"||n==="RUNNING"){a.runningStatus="RUNNING",b.value<88&&(m=1),b.value>88&&(m=.5),b.value>95&&(m=.1);let u=Math.round((b.value+Math.random()*m)*100)/100;u=u>95?95:u,b.value=u}else if(n==="ERROR"){a.runningStatus="ERROR",k.value="",S.value=!1;const u=`/model/taskNode/result/id?taskId=${r}`;O.get(u).then(f=>{let Y=f.data["error-log"];resolve(Y)}).catch(f=>{console.warn(f),reject(f)});const M=(await O.get(u)).data["error-log"];d({title:"模型运行失败",message:`错误原因:
`+M,offset:250,type:"error"}),h.value="运行失败",a.runningStatus="NONE",clearInterval(i)}else if(n==="COMPLETE"){k.value="",S.value=!1,clearInterval(i);let u=(await O.get("/model/taskNode/result/id?taskId="+r)).data;console.log("runningResult ",u),a.caseID=u["case-id"],a.pngPrefix="/model/data/bankResource/down/modelServer/resource/file/image?name=",a.binPrefix="/model/data/bankResource/down/modelServer/resource/file/bin?name=",a.stationBinUrl=u["visualization-station-bin"],a.uvBinUrls=u["visualization-uv-bin"];let M=`/model/data/bankResource/down/modelServer/resource/file/json?name=${u["visualization-description-json"]}`;a.visualizationJsonUrl=M,console.log("globle data info::",a),a.status=!0,a.runningStatus="COMPLETE",h.value="运行完毕",b.value=100}},500)}catch(r){d({title:"模型运行失败",message:`错误原因:
`+r.message,offset:250,type:"error"}),h.value="运行失败",a.runningStatus="NONE",S.value=!1,console.log(h)}};let L=null;const v=(t,o)=>{let s=g.getMap();({lagrange:{add:()=>{console.log("add lagrenge"),L&&L();let i=U(new Ie(a.lagrangeLayer,a.visualizationJsonUrl,a.pngPrefix));L=$(()=>i.stepProgressRate,n=>{l.flowFieldCurrentTimeStep=n}),g.getMap().addLayer(i,"mzsLabel")},remove:()=>{console.log("rm lagrenge"),L&&L(),l.flowFieldCurrentTimeStep=0,s.getLayer(a.lagrangeLayer)&&s.removeLayer(a.lagrangeLayer)}},euler:{add:()=>{console.log("add euler"),L&&L();let i=U(new Oe(a.eulerLayer,a.stationBinUrl,a.uvBinUrls,a.binPrefix));L=$(()=>i.stepProgressRate,n=>{l.flowFieldCurrentTimeStep=n}),g.getMap().addLayer(i,"mzsLabel")},remove:()=>{console.log("rm euler"),L&&L(),l.flowFieldCurrentTimeStep=0,s.getLayer(a.eulerLayer)&&s.removeLayer(a.eulerLayer)}}})[t][o?"add":"remove"]()},X=t=>{if(!a.status){d({title:"错误",message:"模型尚未运行或运行未结束，缺乏可视化依赖数据",offset:250,type:"error"}),_.value=0;return}if(t===1){if(_.value=_.value===1?0:1,v("euler",!1),!_.value){v("lagrange",!1);return}v("lagrange",!0);return}else if(t===2){if(_.value=_.value===2?0:2,v("lagrange",!1),!_.value){v("euler",!1);return}v("euler",!0);return}},pe=()=>{const t=document.createElement("div");return Re(Pe).use(Te).mount(t),t};let B=!1;const _e=()=>{if(!a.status){d({title:"警告",message:"水动力模型计算完成后方可提取潮位过程线",type:"warning",offset:250});return}if(k.value==="正在提取潮位线..."){d({title:"警告",message:"请等待当前任务完成，请稍后...",type:"warning",offset:250});return}d({title:"提示",message:"进入绘制状态，点击地图以添加潮位点",type:"info",offset:250});let t=g.getMap(),o=t.getCanvasContainer();if(o.style.cursor="crosshair",B===!1)t.once("click",s=>{const r=pe(),i=new ae.Popup().setDOMContent(r),n=new ae.Marker({color:"#ff6804ff"}).setLngLat(s.lngLat).setPopup(i).addTo(t),m=n.getElement();l.addMarkerInfo(n,m,s.lngLat.lng,s.lngLat.lat),m.addEventListener("click",function(u){const M=this;l.focusingMarkerDom=M}),d({type:"info",title:"新添潮位点",message:`经度：${s.lngLat.lng.toFixed(4)}，纬度：${s.lngLat.lat.toFixed(4)}`,offset:250}),l.calculatingMarkerDom=m,we(s.lngLat.lng,s.lngLat.lat),o.style.cursor="grab"}),B=!0;else return},we=async(t,o)=>{const s="/model/taskNode/start/numeric/getFlowFieldVelocities",r={"case-id":a.caseID,"sample-points":[{lng:t,lat:o}]};S.value=!0,k.value="正在提取潮位线...";const i=new Ee(s,r);await i.modelStart(),console.log("===Interval");let n=setInterval(async()=>{switch(await i.getRunningStatus()){case"RUNNING":break;case"ERROR":console.log("error"),clearInterval(n);let u=await i.getErrorLog();d({title:"计算失败",message:`错误原因:
`+u,offset:250,type:"error"}),S.value=!1,k.value="",B=!1;break;case"COMPLETE":console.log("complete"),clearInterval(n),d({title:"计算成功",offset:250,type:"success"});let M=await i.getModelResult(),f=ye(M);l.showingOption=f;let Y={option:f};l.appendMarkerInfo(l.calculatingMarkerDom,Y),l.calculatingMarkerDom=null,console.log("runningResult ",M),S.value=!1,k.value="",B=!1;break}},1e3)},ye=t=>{const o=t.result[0].us,s=t.result[0].vs;return{grid:{left:"1%",right:"3%",bottom:"12%",top:"17%",containLabel:!0},tooltip:{trigger:"axis"},xAxis:{type:"category",data:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],name:"时间步",nameLocation:"middle",nameGap:23,nameTextStyle:{fontWeight:"bold"}},yAxis:{type:"value",name:"速度(m/s)",nameTextStyle:{fontWeight:"bold"}},series:[{name:"东西向流速",data:o,type:"line",symbol:"none"},{name:"南北向流速",data:s,type:"line",symbol:"none"}]}},he=(t,o)=>{if(!t)return;let s={民主沙:[[120.45997922676835,32.00001616423072],[120.60909640208264,32.084171362618626]],民主沙右缘:[[120.45997922676835,32.00001616423072],[120.60909640208264,32.084171362618626]]};s[o]&&t.fitBounds(s[o],{duration:1500})},be=async()=>{const t=await Fe();T.value=Z().format("YYYY-MM-DD HH:mm:ss"),R.value={flow:t.flow,diffTide:t.level},d({title:"已更新实时水文条件",message:`更新时间：${T.value}`,offset:250,type:"success"})};return Me(async()=>{let t=await xe(E.value);g.setMap(t),V=Se(F.value);let o=null;$(()=>l.showingOption,s=>{o&&o();let r=JSON.parse(JSON.stringify(oe(s)));console.log("showing option change!::",r),V.setOption(r),o=$(()=>l.flowFieldCurrentTimeStep,i=>{console.log("newVal::",i);let n=JSON.parse(JSON.stringify(oe(l.showingOption))),m=l.getMarkLineOption();n.series[0].markLine=m,V.setOption(n)})})}),Ce(()=>{P().getMap()&&(v("lagrange",!1),v("euler",!1),P().getMap().remove(),P().destroyMap())}),(t,o)=>{const s=N("el-radio-button"),r=N("el-radio-group"),i=N("el-input"),n=N("el-col"),m=N("el-row"),u=N("el-progress"),M=N("dv-loading");return G(),W(Ne,null,[e("div",$e,[c(De,{ModelName:"近岸动力分析模型",onConfirmBank:me}),e("div",ze,[e("div",{class:"map",id:"map",ref_key:"mapRef",ref:E},null,512),e("div",He,[e("div",Ae,[c(r,{modelValue:A.value,"onUpdate:modelValue":o[0]||(o[0]=f=>A.value=f),onChange:o[1]||(o[1]=f=>ue(A.value))},{default:w(()=>[c(s,{label:"近岸动力评估",value:"1"}),c(s,{label:"近岸动力计算",value:"2"}),c(s,{label:"近岸演变分析",value:"3"})]),_:1},8,["modelValue"])])]),e("div",Ye,[c(C(te),{dur:5,color:["rgb(28, 75, 187)","rgb(140, 255, 255)"]},{default:w(()=>[e("div",Je,[e("div",je,[Ge,e("div",We,[e("div",Ke,[qe,Qe,e("div",Xe,[e("div",Ze,[et,c(i,{modelValue:R.value.flow,"onUpdate:modelValue":o[2]||(o[2]=f=>R.value.flow=f),style:{width:"7vw",height:"3vh"},placeholder:"请输入流量"},null,8,["modelValue"])]),e("div",tt,[at,c(i,{modelValue:R.value.diffTide,"onUpdate:modelValue":o[3]||(o[3]=f=>R.value.diffTide=f),style:{width:"7vw",height:"3vh"},placeholder:"请输入潮差"},null,8,["modelValue"])])]),e("button",{class:"realtime-button",onClick:o[4]||(o[4]=f=>be())}," 实时水文条件 "),e("button",{class:z(["condition-button",{active:!0}]),onClick:o[5]||(o[5]=f=>ge("custom"))}," 确定 ")])])]),e("div",ot,[st,e("div",nt,[e("div",lt,[c(m,null,{default:w(()=>[c(n,{span:10},{default:w(()=>[e("div",it,[H(" 状态："),e("span",{style:le(fe.value)},ee(h.value),5)])]),_:1}),c(n,{span:6}),c(n,{span:8},{default:w(()=>[e("div",{class:"running-control grid-content"},[e("div",{class:"run-button",onClick:ve},"运行 ")])]),_:1})]),_:1}),c(m,null,{default:w(()=>[c(n,{span:24},{default:w(()=>[e("div",rt,[e("div",ct,[c(u,{percentage:b.value,"stroke-width":15,striped:""},null,8,["percentage"])])])]),_:1})]),_:1})])])]),e("div",dt,[ut,e("div",ft,[e("div",mt,[e("label",{class:z(["switch",{forbbidden:C(a).status===!1}])},[e("input",{type:"checkbox",checked:_.value==1,disabled:C(a).status===!1,onClick:o[6]||(o[6]=f=>X(1))},null,8,gt),vt],2),pt]),e("div",_t,[e("label",{class:z(["switch",{forbbidden:C(a).status===!1}])},[e("input",{type:"checkbox",checked:_.value==2,disabled:C(a).status===!1,onClick:o[7]||(o[7]=f=>X(2))},null,8,wt),yt],2),ht])])])])]),_:1})]),e("div",bt,[c(C(te),{dur:5,color:["rgb(28, 75, 187)","rgb(140, 255, 255)"]},{default:w(()=>[e("div",kt,[e("div",Lt,[e("div",Mt,[H("● 潮位过程线提取 "),e("div",{class:z(["button",{forbbidden:C(a).status===!1}]),onClick:_e},"测点绘制",2)]),J(e("div",{class:"content flex-center",ref_key:"tideLineChartDom",ref:F},null,512),[[j,C(a).status]]),J(e("div",xt,[(G(),W("span",St,"请在计算模型后绘制潮位点以提取潮位线"))],512),[[j,C(a).status===!1]])])])]),_:1})])])]),J(e("div",Ct,[c(M,{class:"loading-icon"},{default:w(()=>[e("div",Nt,ee(k.value),1)]),_:1})],512),[[j,S.value]])],64)}}},Pt=ne(Rt,[["__scopeId","data-v-dffbe501"]]);export{Pt as default};
