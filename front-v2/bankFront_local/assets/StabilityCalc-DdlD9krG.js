import{_ as De,x as G,f as C,a2 as je,a5 as $,h as $e,aj as Je,v as S,a7 as b,z as Pe,i as v,A as He,o as N,c as M,a as e,b as r,d,u as Z,B as F,C as U,D as m,F as q,r as ee,t as y,O as J,N as ue,k as te,j as fe,ak as Ae,p as Ke,e as Ge}from"./index-DnetMu32.js";import{M as qe}from"./ModelTitle-B0YLcx-e.js";import{a as We,F as Qe,E as Xe}from"./eulerFlowLayer-C_0wVGHG.js";import{B as Ye}from"./bankResourceHelper-l77fC2gR.js";import"./FlowFieldController-CClZrjyg.js";const h=P=>(Ke("data-v-3f8924d4"),P=P(),Ge(),P),Ze={class:"stability-analysis"},et={class:"main-content"},tt={class:"model-choice"},st={class:"basemap-radio-container"},lt={class:"model-pannel one-center"},at={class:"real-content"},ot={class:"tree-container flex-coloum"},nt={class:"card"},it=h(()=>e("div",{class:"title"},[e("span",{style:{"font-size":"medium","margin-left":"0.5vw","margin-right":"0.1vs"}},"➤"),m(" 已建工况 ")],-1)),rt={key:0,class:"content",style:{"flex-grow":"0",height:"35vh"}},dt={key:0,class:"custom-tree-node bank"},ct={key:1,class:"custom-tree-node year"},ut={key:2,class:"custom-tree-node set"},ft=["onClick"],pt={key:3,class:"custom-tree-node case"},mt={key:1,class:"content",style:{"flex-grow":"0",height:"35vh"}},gt=h(()=>e("div",{class:"card one-center"},[e("div",{class:"desc one-center"}," 选择岸段以查看岸段资源信息 ")],-1)),_t=[gt],vt={class:"case-item-info flex-coloum"},ht={class:"card"},yt=h(()=>e("div",{class:"title"},[e("span",{style:{"font-size":"medium","margin-left":"0.5vw","margin-right":"0.1vs"}},"➤"),m(" 工况信息 ")],-1)),kt={class:"content"},wt={class:"card one-center"},bt=h(()=>e("div",{class:"desc one-center"}," 选择工况节点以查看工况信息 ",-1)),Nt=[bt],Ct={class:"visulization-result flex-row"},Rt={class:"card"},It={class:"title"},Mt=h(()=>e("span",{style:{"font-size":"medium","margin-left":"0.5vw","margin-right":"0.1vw"}},"➤",-1)),Lt={class:"content"},xt={class:"slide-control-block"},St=["checked","disabled"],Tt=h(()=>e("span",{class:"slider"},null,-1)),zt=h(()=>e("div",{class:"text-block"},[e("div",{class:"text"},"拉格朗日场")],-1)),Ft={class:"slide-control-block"},Ut=["checked","disabled"],Et=h(()=>e("span",{class:"slider"},null,-1)),Vt=h(()=>e("div",{class:"text-block"},[e("div",{class:"text"},"欧拉场")],-1)),Ot={class:"math-model-calculation flex-coloum",style:{"align-items":"center"}},Bt={class:"main-title"},Dt={class:"file-upload-container one-center"},jt={class:"card border",style:{"margin-top":"0",height:"25.7vh"}},$t=h(()=>e("div",{class:"title"},[e("span",{style:{"font-size":"medium","margin-left":"1vw"}},"➤"),m(" 文件上传 ")],-1)),Jt={class:"content flex-coloum",style:{height:"20vh","justify-content":"space-evenly","align-items":"center"}},Pt={class:"model-container one-center"},Ht={class:"card border"},At=h(()=>e("div",{class:"title"},[e("span",{style:{"font-size":"medium","margin-left":"1vw"}},"➤"),m(" 模型计算 ")],-1)),Kt={class:"content flex-coloum",style:{"justify-content":"flex-start","align-items":"center"}},Gt={class:"setting-container"},qt={class:"judge-container flex-coloum",style:{"justify-content":"center","align-items":"center"}},Wt=h(()=>e("div",{class:"judge-desc"}," 是否作为参考动力条件加入崩岸风险研判 ? ",-1)),Qt={class:"after-judge one-center"},Xt={class:"flex-coloum"},Yt={style:{"margin-bottom":"1vh"}},Zt=h(()=>e("span",null,"流量：",-1)),es=h(()=>e("span",null,"潮型：",-1)),ts={style:{"text-align":"center"}},ss={class:"after-judge one-center"},ls={class:"flex-row"},as=h(()=>e("span",{style:{"line-height":"3.5vh"}},"自定义名称：",-1)),os={class:"running-container"},ns={class:"loading-container"},is={class:"loading-message"},rs=h(()=>e("div",{class:"drawer-header"},[e("div",{class:"icon"}),e("span",{class:"text"},"模型计算进度")],-1)),ds={class:"drawer-content"},cs={class:"top-block"},us={class:"flex-row"},fs=h(()=>e("div",{class:"k"},"工况：",-1)),ps={class:"v"},ms={class:"bot-block"},gs={__name:"StabilityCalc",setup(P){const E=G(),se=C(null),W=C(2),x=C(0),le=C(!1),H=C(!1),V=C(!1),O=C(""),pe=je(),me={children:"children",label:"lable"},ge={dc:"大潮",zc:"中潮",xc:"小潮"},_e={false:"是",true:"否"},T=$({name:null,bankEnName:null}),ae=C([]),B=C(null),ve=async s=>{T.name=s.name,T.bankEnName=s.bankEnName,D(T.bankEnName),Se(E.getMap(map),s.name),b({type:"success",title:"选择岸段",message:`已选择岸段——${T.name},模型计算将采用该岸段相关资源`,position:"top-right",offset:250})},D=async s=>{const t=(await Ye.getBankCalculateResourceList("Hydrodynamic",s)).data,l=await ze(t,s);ie(l)},k=$({flow:0,type:"",temp:!1,desc:"",info:{}}),he=(s,t)=>{if(console.log("nodeData",s),console.log("nodeInfo",t),s.type==="case"){const{flow:l,type:u}=Te(s.lable);k.flow=l,k.type=u,k.temp=s.temp,k.desc=s.description,k.info=t}},z=$({data:{},node:{}}),ye=(s,t)=>{z.data=s,z.node=t,console.log("createNewCaseClickHandler",s,t),H.value=!0},j=We(),A=C(!1),ke=C(null),we=["属性文件","网格文件","控制文件","径流边界","潮位边界"],oe=["fort.13","fort.14","fort.15","fort.19","fort.20"],K=C([[],[],[],[],[]]),f=$({addToRiskJudgeFlag:null,flow:null,tideType:null,customName:null}),be=["小潮","中潮","大潮"],Ne=["xc","zc","dc"],Ce=s=>{console.log("user upload file -- ",s)},Re=()=>{A.value=!0;const s=new FormData;for(let o=0;o<K.value.length;o++){const w=K.value[o],g=oe[o];if(w.length>0){const c=w[0].raw;s.append(g,c)}else{alert("文件未完全上传！");return}}const t=f.addToRiskJudgeFlag==1?""+f.flow+f.tideType:f.customName,l={segment:T.bankEnName,year:z.data.year,set:z.data.set,name:t,temp:f.addToRiskJudgeFlag==1,boundary:"geojson/Mzs/2023/standard/boundary/boundary.geojson"};s.append("info",JSON.stringify(l));const u=B.value.getNode(z.data),n={lable:f.addToRiskJudgeFlag==="1"?`${f.flow}${f.tideType}`:`${f.customName}`,type:"case",tag:"计算中",temp:f.addToRiskJudgeFlag!=="1",description:"",segment:"Mzs"};if(re(B.value.data[0],n.lable)){b({type:"warning",title:"警告",message:`工况【${n.lable}】已存在，请勿重复计算`,offset:250});return}S.post("/model/taskNode/start/numeric/hydrodynamic/real",s).then(o=>{console.log("model start res::",o.data),b.success({message:"模型开始计算",offset:130}),A.value=!1,H.value=!1,B.value.append(n,u),ie(B.value.data);const w=o.data;if(w==="WRONG")throw new Error("模型计算失败");const g={name:t,taskId:w,treeNode:n,treeNodeFather:z.data,progress:0};j.addCalculatingCase(t,g);const c=setInterval(async()=>{const _=(await S.get("/model/taskNode/status/id?taskId="+w)).data;if(console.log("status : ",_),_==="ERROR"||_==="UNLOCK"||_==="NOT FOUND")throw await S.get("/model/taskNode/result/id?taskId="+w),clearInterval(c),I&&clearTimeout(I),new Error("模型计算失败")},2e3),I=setTimeout(()=>{c&&clearInterval(c)},1e3*30)}).catch(o=>{b.error({message:"数学模型计算失败--工况 "+t,offset:130}),delete R.value[t],console.error("数模计算失败",o),A.value=!1})},R=j.calculatingCases,Q=C(!1),Ie=s=>s>=100?"100%":`${s.toFixed(2)}%`,Me=(s,t)=>{s.tag==="计算中"&&(Q.value=!0)},a=$({taskID:null,caseID:null,pngPrefix:null,visualizationJsonUrl:null,stationBinUrl:null,uvBinUrls:null,status:!1,runningStatus:"NONE",lagrangeLayer:"flowLayer1",eulerLayer:"flowLayer2"}),Le=async()=>{console.log(k);const s=async()=>{let t={flow:k.flow,tideType:k.type};if(t.flow===0||t.tideType===""){b({type:"info",title:"请选择工况",offset:250});return}b({type:"info",title:"加载可视化资源",message:`流量${t.flow}，潮型${t.tideType}`,offset:250});let l="",u={};l="/model/taskNode/start/numeric/hydrodynamic",u={"water-qs":t.flow,"tidal-level":t.tideType,segment:"Mzs",set:"standard",year:"2023"},console.log("check1 ",l,u),V.value=!0,O.value="正在加载可视化资源...",a.runningStatus="start";const o=(await S.post(l,u).catch(()=>{V.value=!1,O.value="",b({type:"error",title:"断面形态计算模型启动失败",offset:130})})).data;console.log("TASK_ID ",o),a.taskID=o,console.log("===Interval");let w=setInterval(async()=>{console.log("runningStatusInterval");let g=(await S.get("/model/taskNode/status/id?taskId="+o)).data;if(O.value="正在加载可视化资源...",g==="RUNNING")a.runningStatus="RUNNING",a.status=!1;else if(g==="ERROR"){a.runningStatus="ERROR";const c=`/model/taskNode/result/id?taskId=${o}`,I=(await S.get(c)).data["error-log"];b({title:"模型运行失败",message:`错误原因:
`+I,offset:250,type:"error"}),V.value=!1,O.value="",a.runningStatus="NONE",a.status=!1,clearInterval(w)}else if(g==="COMPLETE"){clearInterval(w);let c=(await S.get("/model/taskNode/result/id?taskId="+o)).data;console.log("runningResult ",c),a.caseID=c["case-id"],a.pngPrefix="/model/data/bankResource/down/modelServer/resource/file/image?name=",a.binPrefix="/model/data/bankResource/down/modelServer/resource/file/bin?name=",a.stationBinUrl=c["visualization-station-bin"],a.uvBinUrls=c["visualization-uv-bin"];let I=`/model/data/bankResource/down/modelServer/resource/file/json?name=${c["visualization-description-json"]}`;a.visualizationJsonUrl=I,console.log("globle data info::",a),V.value=!1,a.status=!0,le.value=!0,a.runningStatus="COMPLETE",b({title:"可视化资源加载完毕",offset:250,type:"success"})}},1e3)};try{if(k.info.data.tag==="计算中"){b({type:"warning",title:"工况尚未计算完毕，无可视化资源",offset:250});return}}catch{b({type:"warning",title:"尚未选择工况节点，无可视化资源",offset:250});return}if(a.runningStatus==="start"||a.runningStatus==="RUNNING"){b({type:"warning",title:"请等待资源加载...",offset:250});return}else a.status=!1,x.value=0,L("lagrange",!1),L("euler",!1),s()},L=(s,t)=>{let l=E.getMap();({lagrange:{add:()=>{console.log("add lagrenge");let n=new Qe(a.lagrangeLayer,a.visualizationJsonUrl,a.pngPrefix);E.getMap().addLayer(n,"mzsLabel")},remove:()=>{console.log("rm lagrenge"),l.getLayer(a.lagrangeLayer)&&l.removeLayer(a.lagrangeLayer)}},euler:{add:()=>{console.log("add euler");let n=new Xe(a.eulerLayer,a.stationBinUrl,a.uvBinUrls,a.binPrefix);E.getMap().addLayer(n,"mzsLabel")},remove:()=>{console.log("rm euler"),l.getLayer(a.eulerLayer)&&l.removeLayer(a.eulerLayer)}}})[s][t?"add":"remove"]()},ne=async s=>{if(console.log(a),le.value){if(s===1){if(x.value=x.value===1?0:1,L("euler",!1),!x.value){L("lagrange",!1);return}L("lagrange",!0);return}else if(s===2){if(x.value=x.value===2?0:2,L("lagrange",!1),!x.value){L("euler",!1);return}L("euler",!0);return}}else{b({type:"warning",title:"请先加载可视化资源",offset:250});return}},xe=s=>{console.log(s=="1");const t={1:"/modelStore/stabilityAnalysis",2:"/modelStore/stabilityCalc",3:"/modelStore/analysisCenter"};t[s]&&pe.push(t[s])};$e(async()=>{let s=await Je(se.value);E.setMap(s),setInterval(()=>{for(let t in R)R[t].progress<99&&(R[t].progress+=Math.random()*.003)},1e3);for(let t in R){let l=t,u=R[l].taskId;S.get("/model/taskNode/status/id?taskId="+u).then(o=>{console.log(l,"  ",o.data),o.data==="COMPLETE"?(R[l].progress=100,D()):(o.data==="ERROR"||o.data==="UNLOCK"||o.data==="NOT FOUND")&&(b.error({message:"模型计算失败--工况 "+l,offset:130}),delete R[l],D())});let n=setInterval(()=>{S.get("/model/taskNode/status/id?taskId="+u).then(o=>{console.log(l,"  ",o.data),o.data==="COMPLETE"?(n&&clearInterval(n),R[l].progress=100,D()):(o.data==="ERROR"||o.data==="UNLOCK"||o.data==="NOT FOUND")&&(b.error({message:"模型计算失败--工况 "+l,offset:130}),delete R[l],D(),n&&clearInterval(n))})},10*60*1e3)}}),Pe(()=>{G().getMap()&&(L("lagrange",!1),L("euler",!1),G().getMap().remove(),G().destroyMap())});const Se=(s,t)=>{if(!s)return;let l={民主沙:[[120.45997922676835,32.00001616423072],[120.60909640208264,32.084171362618626]],民主沙右缘:[[120.45997922676835,32.00001616423072],[120.60909640208264,32.084171362618626]]};l[t]&&s.fitBounds(l[t],{duration:1500})},ie=s=>{ae.value=s},re=(s,t)=>{let l;if(s.lable===t)l=!0;else if(s.children)for(let u=0;u<s.children.length&&(l=re(s.children[u],t),!l);u++);return l},Te=s=>{let t=parseInt(s.slice(0,-2)),l=s.slice(s.length-2,s.length);return console.log(t,l),{flow:t,type:l}},ze=async(s,t)=>{const l=[{lable:t,type:"bank",children:[]}];let u=[];for(let n=0;n<s.length;n++){let o={lable:s[n].year,type:"year",children:[]},w=[];for(let g=0;g<s[n].sets.length;g++){let c={lable:s[n].sets[g].name,type:"set",children:[]},I=[];for(let _=0;_<s[n].sets[g].list.length;_++){let X={lable:s[n].sets[g].list[_].name,type:"case",tag:"已计算",temp:s[n].sets[g].list[_].temp,description:s[n].sets[g].list[_].description};I.push(X)}for(let _ in j.calculatingCases)c.lable===j.calculatingCases[_].treeNodeFather.lable&&I.push(j.calculatingCases[_].treeNode);c.children=I,w.push(c)}o.children=w,u.push(o)}return l[0].children=u,console.log(l),l};return(s,t)=>{const l=v("el-radio-button"),u=v("el-radio-group"),n=v("el-tag"),o=v("el-tooltip"),w=v("el-tree"),g=v("el-scrollbar"),c=v("el-descriptions-item"),I=v("el-descriptions"),_=v("el-button"),X=v("el-upload"),de=v("el-radio"),ce=v("el-input"),Fe=v("el-option"),Ue=v("el-select"),Ee=v("dv-loading"),Ve=v("el-progress"),Oe=v("el-drawer"),Be=He("loading");return N(),M(q,null,[e("div",Ze,[r(qe,{ModelName:"近岸动力分析模型",onConfirmBank:ve}),e("div",et,[e("div",{class:"map",id:"map",ref_key:"mapRef",ref:se},null,512),e("div",tt,[e("div",st,[r(u,{modelValue:W.value,"onUpdate:modelValue":t[0]||(t[0]=i=>W.value=i),onChange:t[1]||(t[1]=i=>xe(W.value))},{default:d(()=>[r(l,{label:"近岸动力评估",value:"1"}),r(l,{label:"近岸动力计算",value:"2"}),r(l,{label:"近岸演变分析",value:"3"})]),_:1},8,["modelValue"])])]),e("div",lt,[r(Z(Ae),{dur:5,color:["rgb(28, 75, 187)","rgb(140, 255, 255)"]},{default:d(()=>[e("div",at,[e("div",ot,[e("div",nt,[it,r(g,{height:"34vh"},{default:d(()=>[T.name?(N(),M("div",rt,[r(w,{data:ae.value,props:me,onNodeClick:he,"default-expand-all":"","expand-on-click-node":!1,ref_key:"treeRef",ref:B},{default:d(({node:i,data:p})=>[p.type==="bank"?(N(),M("span",dt,[e("span",null,y(i.label),1)])):J("",!0),p.type==="year"?(N(),M("span",ct,[e("span",null,y(i.label),1)])):J("",!0),p.type==="set"?(N(),M("span",ut,[e("span",null,y(i.label),1),e("span",null,[e("div",{onClick:ue(Y=>ye(p,i),["stop"]),class:"button"}," 新建工况 ",8,ft)])])):J("",!0),p.type==="case"?(N(),M("div",pt,[e("span",null,y(i.label),1),p.tag==="已计算"?(N(),te(n,{key:0,type:"success"},{default:d(()=>[m(y(p.tag),1)]),_:2},1024)):(N(),te(o,{key:1,content:"点击查看计算进度",placement:"top",effect:"light"},{default:d(()=>[r(n,{type:"info",onClick:ue(Y=>Me(p,i),["stop"])},{default:d(()=>[m(y(p.tag),1)]),_:2},1032,["onClick"])]),_:2},1024)),p.tag==="错误"?(N(),te(n,{key:2,type:"error"},{default:d(()=>[m(y(p.tag),1)]),_:2},1024)):J("",!0)])):J("",!0)]),_:1},8,["data"])])):(N(),M("div",mt,_t))]),_:1})])]),e("div",vt,[e("div",ht,[yt,e("div",kt,[F(r(I,{direction:"horizontal",column:3,size:"default",border:""},{default:d(()=>[r(c,{label:"流量",span:1,width:"1vw",align:"center","class-name":"item"},{default:d(()=>[m(y(k.flow),1)]),_:1}),r(c,{label:"潮型",span:1,width:"1vw",align:"center","class-name":"item"},{default:d(()=>[m(y(ge[k.type]),1)]),_:1}),r(c,{label:"是否加入研判",span:1,align:"center"},{default:d(()=>[r(n,{size:"small","class-name":"item"},{default:d(()=>[m(y(_e[k.temp]),1)]),_:1})]),_:1}),r(c,{label:"备注",align:"left","class-name":"item"},{default:d(()=>[m(y(k.desc),1)]),_:1})]),_:1},512),[[U,k.flow!=0]]),F(e("div",wt,Nt,512),[[U,k.flow==0]])])])]),e("div",Ct,[e("div",Rt,[e("div",It,[Mt,m(" 工况可视化 "),r(_,{style:{"margin-left":"3vw","background-color":"rgb(197,232,252)",color:"rgb(7, 82, 119)","font-weight":"700",border:"0","font-size":"calc(0.65vw + 0.5vh)",padding:"3px 10px"},type:"info",plane:"",onClick:Le},{default:d(()=>[m("加载可视化资源")]),_:1})]),e("div",Lt,[e("div",xt,[e("label",{class:fe(["switch",{forbbidden:a.status===!1}])},[e("input",{type:"checkbox",checked:x.value==1,onClick:t[2]||(t[2]=i=>ne(1)),disabled:a.status===!1},null,8,St),Tt],2),zt]),e("div",Ft,[e("label",{class:fe(["switch",{forbbidden:a.status===!1}])},[e("input",{type:"checkbox",checked:x.value==2,onClick:t[3]||(t[3]=i=>ne(2)),disabled:a.status===!1},null,8,Ut),Et],2),Vt])])])])])]),_:1})]),F((N(),M("div",Ot,[e("div",Bt,[m(" 数学模型计算 "),e("div",{class:"minimize-btn",onClick:t[4]||(t[4]=i=>H.value=!1)})]),e("div",Dt,[e("div",jt,[$t,e("div",Jt,[(N(),M(q,null,ee(we,(i,p)=>r(X,{"file-list":K.value[p],"onUpdate:fileList":Y=>K.value[p]=Y,action:"#","show-file-list":!1,limit:1,ref_for:!0,ref_key:"uploadRef",ref:ke,"http-request":Ce,style:{height:"4vh"}},{default:d(()=>[r(_,{type:"primary",plain:""},{default:d(()=>[m(y(i)+" ",1),e("span",null,"("+y(oe[p])+")",1)]),_:2},1024)]),_:2},1032,["file-list","onUpdate:fileList"])),64))])])]),e("div",Pt,[e("div",Ht,[At,e("div",Kt,[e("div",Gt,[e("div",qt,[Wt,r(u,{modelValue:f.addToRiskJudgeFlag,"onUpdate:modelValue":t[5]||(t[5]=i=>f.addToRiskJudgeFlag=i)},{default:d(()=>[r(de,{value:"1",size:"large"},{default:d(()=>[m(" 是 ")]),_:1}),r(de,{value:"2",size:"large"},{default:d(()=>[m(" 否 ")]),_:1})]),_:1},8,["modelValue"]),F(e("div",Qt,[e("div",Xt,[e("div",Yt,[Zt,r(ce,{modelValue:f.flow,"onUpdate:modelValue":t[6]||(t[6]=i=>f.flow=i),style:{width:"8vw",height:"3.5vh"},placeholder:"请输入流量"},null,8,["modelValue"])]),e("div",null,[es,r(Ue,{modelValue:f.tideType,"onUpdate:modelValue":t[7]||(t[7]=i=>f.tideType=i),placeholder:"请选择潮型",style:{width:"8vw",height:"3.5vh"},onChange:t[8]||(t[8]=()=>{})},{default:d(()=>[(N(),M(q,null,ee(be,(i,p)=>r(Fe,{key:p,label:i,value:Ne[p]},{default:d(()=>[e("div",ts,y(i),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"])])])],512),[[U,f.addToRiskJudgeFlag==1]]),F(e("div",ss,[e("div",ls,[as,r(ce,{modelValue:f.customName,"onUpdate:modelValue":t[9]||(t[9]=i=>f.customName=i),style:{width:"6vw",height:"3.5vh"},placeholder:"请输入名称"},null,8,["modelValue"])])],512),[[U,f.addToRiskJudgeFlag==2]])])]),e("div",os,[r(_,{type:"primary",plain:"",onClick:Re},{default:d(()=>[m("确认并运行")]),_:1})])])])])])),[[U,H.value],[Be,A.value]])])]),F(e("div",ns,[r(Ee,{class:"loading-icon"},{default:d(()=>[e("div",is,y(O.value),1)]),_:1})],512),[[U,V.value]]),r(Oe,{modelValue:Q.value,"onUpdate:modelValue":t[10]||(t[10]=i=>Q.value=i),"with-header":!1,direction:"rtl"},{default:d(()=>[rs,e("div",ds,[(N(!0),M(q,null,ee(Object.keys(Z(R)),(i,p)=>(N(),M("div",{class:"progress-card",key:p},[e("div",cs,[e("div",us,[fs,e("div",ps,y(i),1)]),r(n,{type:"info"},{default:d(()=>[m("运行中")]),_:1})]),e("div",ms,[r(Ve,{percentage:Z(R)[i].progress||0,"stroke-width":20,format:Ie,striped:"","striped-flow":"",duration:25},null,8,["percentage"])])]))),128))])]),_:1},8,["modelValue"])],64)}}},ws=De(gs,[["__scopeId","data-v-3f8924d4"]]);export{ws as default};
